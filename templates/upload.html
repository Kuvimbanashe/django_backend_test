<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bulk Upload UI</title>
  <style>body { font-family: Arial; margin: 30px; } .progress { width: 100%; background: #eee; border-radius: 6px; overflow: hidden; } .bar { height: 18px; background: #4caf50; width: 0%; transition: width .3s; } table { border-collapse: collapse; width: 100%; margin-top: 16px; } th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }</style>
</head>
<body>
  <h1>Bulk Product Upload (Demo)</h1>
  <input id="file" type="file" accept=".csv"/>
  <button id="upload">Upload</button>
  <p id="message"></p>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <p>Progress: <span id="percent">0%</span></p>
  <h2>Report</h2>
  <pre id="report"></pre>
  <h2>Products (latest)</h2>
  <button id="refresh">Refresh Products</button>
  <table id="products">
    <thead><tr><th>SKU</th><th>Name</th><th>Price</th><th>Stock</th><th>Active</th></tr></thead>
    <tbody></tbody>
  </table>
<script>
const uploadBtn = document.getElementById('upload');
const fileInput = document.getElementById('file');
const msg = document.getElementById('message');
const bar = document.getElementById('bar');
const pct = document.getElementById('percent');
const reportEl = document.getElementById('report');
const refreshBtn = document.getElementById('refresh');
const productsTbody = document.querySelector('#products tbody');
function updateProducts(){
  fetch('/api/products/').then(r=>r.json()).then(data=>{
    productsTbody.innerHTML = '';
    data.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.sku}</td><td>${p.name}</td><td>${p.price}</td><td>${p.stock_count}</td><td>${p.is_active}</td>`;
      productsTbody.appendChild(tr);
    });
  });
}
refreshBtn.onclick = updateProducts;
updateProducts();
uploadBtn.onclick = ()=>{
  const f = fileInput.files[0];
  if(!f){ alert('Choose CSV first'); return; }
  const fd = new FormData();
  fd.append('file', f);
  msg.textContent = 'Uploading...';
  fetch('/api/products/bulk-upload/', { method: 'POST', body: fd })
    .then(r=>r.json())
    .then(data => {
      if(data.task_id){
        msg.textContent = 'Upload accepted. Task id: ' + data.task_id;
        pollStatus(data.task_id);
      } else {
        msg.textContent = JSON.stringify(data);
      }
    });
};
function pollStatus(task_id){
  const iv = setInterval(()=>{
    fetch('/api/tasks/' + task_id + '/status/').then(r=>r.json()).then(data=>{
      bar.style.width = (data.progress||0) + '%';
      pct.textContent = (data.progress||0) + '%';
      if(data.status === 'SUCCESS' || data.status === 'FAILURE'){
        clearInterval(iv);
        reportEl.textContent = JSON.stringify(data.report, null, 2);
        updateProducts();
      }
    }).catch(e=>{ console.error(e); });
  }, 1500);
}
</script>
</body>
</html>
